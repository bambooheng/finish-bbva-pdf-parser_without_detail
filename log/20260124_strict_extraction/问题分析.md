# 5个问题的根本原因分析

## 问题1：截图1头部信息未在JSON中出现

**现象**：
- 虽然实现了 `_extract_customer_info` 方法
- 但输出的 JSON 中完全没有 `customer_info` 字段

**根本原因分析**：
1. **提取失败**：`_extract_customer_info` 的正则表达式可能没有成功匹配到PDF文本
   - 原因：PDF中的文本可能包含额外的空格、换行符
   - 原因：regex 模式不够宽松
2. **调用位置问题**：虽然在 `extract_structured_data` 中调用了，但可能在错误的时机调用
3. **输出逻辑缺失**：即使提取到了，`to_simplified_dict` 可能没有正确输出
4. **Key格式错误**：用户期望的格式是 "Periodo DEL", "Fecha de Corte" 等（带空格和大小写），但我的代码中使用的是 "periodo", "fecha_corte" 等小写下划线格式

**修复方案**：
- 使用更宽松的regex，允许任意空白符
- 确保在 `to_simplified_dict` 中正确输出
- **关键**：输出时使用原文key，如 "Periodo" -> "DEL ... AL ..." 而不是转换成下划线格式

---

## 问题2：informacion_financiera 的 key 被翻译/转译

**现象**：
```json
"informacion_financiera": {
  "saldo_promedio": "25995.51",
  "dias_periodo": "30",
  ...
}
```

**根本原因**：
- 在 `_extract_informacion_financiera` 中，我定义的 `target_keys` 字典将原文标签（如 "Saldo Promedio"）映射到了下划线格式的key（如 "saldo_promedio"）
- 这违反了"完全保持原文"的要求

**修复方案**：
- 直接使用原文作为key：`"Saldo Promedio": "25995.51"`
- 不做任何转译或下划线化

---

## 问题3：apartados_vigentes 数据来源不明

**现象**：
```json
"apartados_vigentes": [
  {"nombre_apartado": "Emilio", "importe_apartado": "4500.00"},
  {"nombre_apartado": "Emilio 2", "importe_apartado": "500.00"}
]
```

**根本原因分析**：
- 需要确认原文PDF中是否真的有 "Estado de cuenta de Apartados Vigentes" 的详细列表
- 从截图2看，只有一个汇总值 "Total de Apartados en Global: $ 02 5,000.00"
- 如果原文中没有 "Emilio", "Emilio 2" 这样的详细条目，则这是错误提取或测试数据残留

**待确认**：需要查看完整PDF文本

**修复方案**：
- 如果原文中没有详细的apartados列表，应删除此提取逻辑
- 或者只提取汇总值，不提取详细条目

---

## 问题4：comportamiento 的 key 格式和值格式问题

**现象**：
```json
"comportamiento": {
  "saldo_anterior": "12383.20",
  "depositos_count": 5,
  "depositos_amount": "233768.72",
  ...
}
```

**根本原因**：
1. **Key被转译**：将 "Depósitos / Abonos (+)" 转换成了 "depositos_count" 和 "depositos_amount"
2. **值被拆分**：原文是一行显示"5  233,768.72"，我拆分成了count和amount两个字段
3. **违反原文格式**：用户要求保持原文的 key，值也应该合并

**修复方案**：
- 使用原文key：`"Depósitos / Abonos (+)": "5  233,768.72"`
- 不拆分字段，保持原文的格式（可能是 "数量 空格 金额"）

---

## 问题5：截图2信息未单独解析

**现象**：
- 截图2显示了 "Otros productos incluidos en el estado de cuenta (inversiones)" 表格
- 当前输出中没有这部分信息

**根本原因**：
- 没有实现针对此部分的提取逻辑
- 这是一个新的需求

**修复方案**：
- 新增 `_extract_otros_productos` 方法
- 提取表格信息（Contrato, Producto, Tasa de Interés anual, GAT Nominal, GAT Real, Total de comisiones）
- 提取 "Total de Apartados en Global" 信息

---

## 总结

所有问题的根本原因都是：**我在提取过程中对原文进行了"翻译"、"转换"、"拆分"等加工处理**，违反了用户"完全保持原文格式"的核心要求。

**修复原则**：
1. **Key必须是原文**：包括空格、大小写、特殊字符（如 "Depósitos / Abonos (+)"）
2. **Value必须是原文格式**：不拆分、不重组
3. **只提取真实存在的内容**：不推断、不补充
4. **流水明细部分完全不动**：已确认正确
